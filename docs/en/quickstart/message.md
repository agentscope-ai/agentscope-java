# Message

Message is the core concept in AgentScope, used to support multimodal data, tool APIs, information storage/exchange, and prompt construction.

## Message Structure

A message consists of four fields:

| Field    | Type                  | Description                                                                 |
|----------|-----------------------|-----------------------------------------------------------------------------|
| id       | `String`              | Unique identifier for the message (auto-generated)                          |
| name     | `String`              | The name/identity of the message sender                                     |
| role     | `MsgRole`             | The role of the sender: `USER`, `ASSISTANT`, `SYSTEM`, or `TOOL`            |
| content  | `List<ContentBlock>`  | List of content blocks (text, images, audio, video, tool calls, etc.)       |
| metadata | `Map<String, Object>` | Optional metadata for additional information or structured output            |

> **Note**:
> - In applications with multiple identities, the `name` field distinguishes different participants.
> - The `metadata` field is recommended for structured output, which won't be included in prompt construction.

## Creating Messages

### Text Message

The simplest way to create a message with text content:

```java
package io.agentscope.tutorial.quickstart;

import io.agentscope.core.message.Msg;
import io.agentscope.core.message.MsgRole;
import io.agentscope.core.message.TextBlock;
import java.util.List;

public class MessageExample {
    public static void main(String[] args) {
        Msg msg = Msg.builder()
                .name("Alice")
                .role(MsgRole.USER)
                .content(List.of(TextBlock.builder().text("Hello, AgentScope!").build()))
                .build();

        System.out.println("Sender: " + msg.getName());
        System.out.println("Role: " + msg.getRole());
        System.out.println("Content: " + msg.getTextContent());
    }
}
```

### Multimodal Message

AgentScope supports multimodal content through different content blocks:

| Block Type      | Description              | Example                                                     |
|-----------------|--------------------------|-------------------------------------------------------------|
| TextBlock       | Plain text data          | `TextBlock.builder().text("Hello, world!")`                             |
| ImageBlock      | Image data               | `ImageBlock.builder().source(URLSource.of("https://example.com/img.jpg")).build()`|
| AudioBlock      | Audio data               | `AudioBlock.builder().source(URLSource.of("https://example.com/audio.mp3")).build()`|
| VideoBlock      | Video data               | `VideoBlock.builder().source(URLSource.of("https://example.com/video.mp4")).build()`|
| ThinkingBlock   | Reasoning content        | `ThinkingBlock.builder().thinking("Let me think about this...").build()`            |
| ToolUseBlock    | Tool call request        | Created by LLM during reasoning                             |
| ToolResultBlock | Tool execution result    | Created after tool execution                                |

#### Image Message with Base64

```java
import io.agentscope.core.message.ImageBlock;
import io.agentscope.core.message.Base64Source;

Msg imgMsg = Msg.builder()
        .name("Assistant")
        .role(MsgRole.ASSISTANT)
        .content(List.of(
                TextBlock.builder().text("Here is the image you requested:").build(),
                ImageBlock.builder().source(Base64Source.builder()
                        .mediaType("image/jpeg")
                        .data("/9j/4AAQSkZ...")  // Base64 encoded data
                        .build()).build()
        ))
        .build();
```

#### Image Message with URL

```java
import io.agentscope.core.message.URLSource;

Msg urlImgMsg = Msg.builder()
        .name("Assistant")
        .role(MsgRole.ASSISTANT)
        .content(List.of(
                TextBlock.builder().text("Processing image from URL:").build(),
                ImageBlock.builder().source(URLSource.of("https://example.com/image.jpg")).build()
        ))
        .build();
```

### Thinking Message

For reasoning models that support chain-of-thought:

```java
import io.agentscope.core.message.ThinkingBlock;

Msg thinkingMsg = Msg.builder()
        .name("Reasoner")
        .role(MsgRole.ASSISTANT)
        .content(List.of(
                ThinkingBlock.builder().thinking("First, I need to understand the problem... " +
                                 "Then I should break it down into steps...").build(),
                TextBlock.builder().text("Based on my analysis, the answer is 42.").build()
        ))
        .build();
```

### Tool Call Message

Tool call messages are typically generated by LLMs during the reasoning phase:

```java
import io.agentscope.core.message.ToolUseBlock;
import java.util.Map;

Msg toolCallMsg = Msg.builder()
        .name("Assistant")
        .role(MsgRole.ASSISTANT)
        .content(List.of(
                ToolUseBlock.builder()
                        .id("call_123")
                        .name("get_weather")
                        .arguments(Map.of("location", "Beijing"))
                        .build()
        ))
        .build();
```

### Tool Result Message

Tool result messages are generated after executing tools:

```java
import io.agentscope.core.message.ToolResultBlock;

Msg toolResultMsg = Msg.builder()
        .name("system")
        .role(MsgRole.TOOL)
        .content(List.of(
                ToolResultBlock.builder()
                        .id("call_123")
                        .name("get_weather")
                        .result(TextBlock.builder().text("Sunny, 25°C").build())
                        .build()
        ))
        .build();
```

> **Tip**: Refer to the [Tool](../task/tool.md) section for more information about tool APIs in AgentScope.

## Message Metadata

The metadata field is useful for structured output and additional information:

```java
import java.util.Map;

Msg msgWithMetadata = Msg.builder()
        .name("Assistant")
        .role(MsgRole.ASSISTANT)
        .content(List.of(TextBlock.builder().text("Task completed").build()))
        .metadata(Map.of(
                "task_id", "12345",
                "priority", 3,
                "tags", List.of("important", "urgent")
        ))
        .build();

// Check if metadata exists
if (msgWithMetadata.hasStructuredData()) {
    System.out.println("Metadata: " + msgWithMetadata.getMetadata());
}
```

### Structured Output

When working with structured output from LLMs:

```java
public class TaskPlan {
    public String goal;
    public List<String> steps;
    public int estimatedHours;
}

// After agent generates structured output
Msg planMsg = agent.call(inputMsg, TaskPlan.class).block();

// Extract structured data
if (planMsg.hasStructuredData()) {
    TaskPlan plan = planMsg.getStructuredData(TaskPlan.class);
    System.out.println("Goal: " + plan.goal);
    System.out.println("Steps: " + plan.steps);
}
```

## Serialization

Messages can be serialized to and from JSON:

```java
import com.fasterxml.jackson.databind.ObjectMapper;

ObjectMapper mapper = new ObjectMapper();

// Serialize to JSON string
String jsonString = mapper.writeValueAsString(msg);
System.out.println("JSON: " + jsonString);

// Deserialize from JSON string
Msg deserializedMsg = mapper.readValue(jsonString, Msg.class);
System.out.println("Deserialized name: " + deserializedMsg.getName());
```

## Utility Methods

AgentScope provides convenient methods for working with messages:

### Get Text Content

```java
// Get all text from TextBlock elements, joined by newline
String textContent = msg.getTextContent();
```

### Check Content Types

```java
// Check if message has specific content block type
boolean hasImages = msg.hasContentBlocks(ImageBlock.class);
boolean hasToolCalls = msg.hasContentBlocks(ToolUseBlock.class);
```

### Get Content Blocks by Type

```java
// Get all image blocks
List<ImageBlock> images = msg.getContentBlocks(ImageBlock.class);

// Get first text block
TextBlock firstText = msg.getFirstContentBlock(TextBlock.class);
```

### Create Copy with Different Name

```java
// Create a copy with different name (useful for multi-agent scenarios)
Msg renamedMsg = msg.toBuilder()
        .name("Bob")
        .build();
```

## Message Roles

AgentScope defines four message roles:

```java
public enum MsgRole {
    USER,       // Messages from users
    ASSISTANT,  // Messages from AI assistants
    SYSTEM,     // System messages (prompts, instructions)
    TOOL        // Tool execution results
}
```

### Role Usage

- **USER**: Human input, task descriptions, questions
- **ASSISTANT**: Agent responses, reasoning output, tool calls
- **SYSTEM**: System prompts, instructions, context
- **TOOL**: Tool execution results (always paired with ToolResultBlock)

## Best Practices

1. **Use Builder Pattern**: Always use the builder to create messages for clarity and immutability
2. **Content as List**: Even for single-block content, use `List.of()` for consistency
3. **Metadata for Structure**: Put structured data in metadata, not in text content
4. **Check Before Access**: Use `hasContentBlocks()` before accessing specific block types
5. **Immutable Design**: Messages are immutable; use `toBuilder()` to create modified copies

## Complete Example

Here's a comprehensive example demonstrating various message types:

```java
package io.agentscope.tutorial.quickstart;

import io.agentscope.core.message.*;
import java.util.List;
import java.util.Map;

public class CompleteMessageExample {
    public static void main(String[] args) {
        // 1. Simple text message
        Msg userMsg = Msg.builder()
                .name("User")
                .role(MsgRole.USER)
                .content(List.of(TextBlock.builder().text("What's the weather like?").build()))
                .build();

        // 2. Multimodal message with thinking
        Msg assistantMsg = Msg.builder()
                .name("Assistant")
                .role(MsgRole.ASSISTANT)
                .content(List.of(
                        ThinkingBlock.builder().thinking("I need to call the weather API...").build(),
                        TextBlock.builder().text("Let me check the weather for you.").build()
                ))
                .build();

        // 3. Tool call message
        Msg toolCallMsg = Msg.builder()
                .name("Assistant")
                .role(MsgRole.ASSISTANT)
                .content(List.of(
                        ToolUseBlock.builder()
                                .id("call_001")
                                .name("get_weather")
                                .arguments(Map.of("location", "Beijing"))
                                .build()
                ))
                .build();

        // 4. Tool result message
        Msg toolResultMsg = Msg.builder()
                .name("system")
                .role(MsgRole.TOOL)
                .content(List.of(
                        ToolResultBlock.builder()
                                .id("call_001")
                                .name("get_weather")
                                .result(TextBlock.builder().text("Sunny, 25°C").build())
                                .build()
                ))
                .build();

        // 5. Final response with metadata
        Msg finalMsg = Msg.builder()
                .name("Assistant")
                .role(MsgRole.ASSISTANT)
                .content(List.of(
                        TextBlock.builder().text("The weather in Beijing is sunny with 25°C.").build()
                ))
                .metadata(Map.of(
                        "temperature", 25,
                        "condition", "sunny",
                        "location", "Beijing"
                ))
                .build();

        // Print all messages
        System.out.println("User: " + userMsg.getTextContent());
        System.out.println("Assistant: " + assistantMsg.getTextContent());
        System.out.println("Tool Call: " + toolCallMsg.getFirstContentBlock(ToolUseBlock.class).getName());
        System.out.println("Tool Result: " + toolResultMsg.getFirstContentBlock(ToolResultBlock.class).getResult());
        System.out.println("Final: " + finalMsg.getTextContent());
        System.out.println("Metadata: " + finalMsg.getMetadata());
    }
}
```

## Next Steps

- [Agent](agent.md) - Build agents that process messages
- [Tool](../task/tool.md) - Learn about tool integration
- [Hook](../task/hook.md) - Customize message processing
- [Model](../task/model.md) - Configure LLM models

## Reference

- [Msg.java](https://github.com/agentscope-ai/agentscope-java/blob/main/src/main/java/io/agentscope/core/message/Msg.java) - Message class source code
- [ContentBlock.java](https://github.com/agentscope-ai/agentscope-java/blob/main/src/main/java/io/agentscope/core/message/ContentBlock.java) - Content block interface
