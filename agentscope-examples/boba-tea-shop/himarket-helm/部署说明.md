# HiMarket Auto-Init Helm Chart éƒ¨ç½²è¯´æ˜

## ğŸ“¦ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**å¼€ç®±å³ç”¨**çš„ HiMarket Helm Chartï¼ŒåŸºäº `himarket-server-auto-init` Docker é•œåƒæ„å»ºï¼Œæä¾›ä¸€é”®éƒ¨ç½²çš„ HiMarket æœåŠ¡ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **é›¶è„šæœ¬ä¾èµ–** - æ‰€æœ‰åˆå§‹åŒ–é€»è¾‘å·²å†…ç½®åœ¨ Docker é•œåƒä¸­
- âœ… **å¯é€‰å†…ç½® MySQL** - æ”¯æŒä¸€é”®éƒ¨ç½²å®Œæ•´ç¯å¢ƒæˆ–è¿æ¥å¤–éƒ¨æ•°æ®åº“
- âœ… **çµæ´»é…ç½®** - é€šè¿‡ `values.yaml` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®
- âœ… **MCP å¼€ç®±å³ç”¨** - å†…ç½® 5 ä¸ª MCP Serverï¼Œè‡ªåŠ¨å¯¼å…¥å’Œä¸Šæ¶
- âœ… **å¤šåœºæ™¯æ”¯æŒ** - æä¾›æœ€å°åŒ–ã€å®Œæ•´ã€å•†ä¸šåŒ–ç­‰å¤šç§éƒ¨ç½²æ¨¡æ¿

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
himarket-auto-init/
â”œâ”€â”€ Chart.yaml                    # Chart å…ƒæ•°æ®
â”œâ”€â”€ values.yaml                   # é»˜è®¤é…ç½®ï¼ˆå¿…è¯»ï¼‰
â”œâ”€â”€ values-minimal.yaml           # æœ€å°åŒ–éƒ¨ç½²é…ç½®
â”œâ”€â”€ values-full.yaml              # å®Œæ•´éƒ¨ç½²é…ç½®
â”œâ”€â”€ values-commercial.yaml        # å•†ä¸šåŒ–éƒ¨ç½²é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰
â”œâ”€â”€ .helmignore                   # Helm æ‰“åŒ…å¿½ç•¥è§„åˆ™
â”‚
â”œâ”€â”€ templates/                    # Kubernetes æ¨¡æ¿
â”‚   â”œâ”€â”€ _helpers.tpl             # è¾…åŠ©å‡½æ•°
â”‚   â”œâ”€â”€ deployment.yaml          # HiMarket Server Deployment
â”‚   â”œâ”€â”€ service.yaml             # HiMarket Server Service
â”‚   â”œâ”€â”€ mysql-statefulset.yaml   # MySQL StatefulSetï¼ˆå¯é€‰ï¼‰
â”‚   â”œâ”€â”€ mysql-service.yaml       # MySQL Serviceï¼ˆå¯é€‰ï¼‰
â”‚   â””â”€â”€ NOTES.txt                # éƒ¨ç½²åæç¤ºä¿¡æ¯
â”‚
â”œâ”€â”€ install.sh                    # äº¤äº’å¼å®‰è£…è„šæœ¬ â­
â”œâ”€â”€ uninstall.sh                  # å¸è½½è„šæœ¬
â”œâ”€â”€ Makefile                      # å¿«é€Ÿå‘½ä»¤å·¥å…· â­
â”‚
â””â”€â”€ æ–‡æ¡£/
    â”œâ”€â”€ README.md                 # å®Œæ•´è¯´æ˜æ–‡æ¡£ï¼ˆå¿…è¯»ï¼‰
    â”œâ”€â”€ USAGE.md                  # ä½¿ç”¨æŒ‡å—
    â”œâ”€â”€ QUICKSTART.md             # 5 åˆ†é’Ÿå¿«é€Ÿå¼€å§‹ â­
    â”œâ”€â”€ CHANGELOG.md              # å˜æ›´æ—¥å¿—
    â””â”€â”€ éƒ¨ç½²è¯´æ˜.md               # æœ¬æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ 1: ä½¿ç”¨å®‰è£…è„šæœ¬ï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
cd himarket/deploy/himarket-auto-init
./install.sh
```

æŒ‰ç…§æç¤ºé€‰æ‹©ï¼š
1. æœ€å°åŒ–éƒ¨ç½²ï¼ˆä»… HiMarket + å†…ç½® MySQLï¼‰
2. é›†æˆ Nacos
3. å®Œæ•´éƒ¨ç½²ï¼ˆNacos + Gateway + MCPï¼‰
4. è‡ªå®šä¹‰é…ç½®

---

### æ–¹å¼ 2: ä½¿ç”¨ Makefileï¼ˆæ¨èå¼€å‘è€…ï¼‰

```bash
cd himarket/deploy/himarket-auto-init

# æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
make help

# æœ€å°åŒ–å®‰è£…
make install

# å®Œæ•´å®‰è£…
make install-full

# æŸ¥çœ‹çŠ¶æ€
make status

# æŸ¥çœ‹æ—¥å¿—
make logs

# ç«¯å£è½¬å‘
make port-forward
```

---

### æ–¹å¼ 3: ä½¿ç”¨ Helm å‘½ä»¤ï¼ˆæ¨èè¿ç»´ï¼‰

```bash
cd himarket/deploy/himarket-auto-init

# æœ€å°åŒ–éƒ¨ç½²
helm install himarket . --set mysql.enabled=true

# ä½¿ç”¨é…ç½®æ–‡ä»¶
helm install himarket . -f values-minimal.yaml

# è‡ªå®šä¹‰å‚æ•°
helm install himarket . \
  --set mysql.enabled=true \
  --set nacos.enabled=true \
  --set nacos.serverUrl=http://nacos:8848
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: æœ¬åœ°å¼€å‘ï¼ˆ5 åˆ†é’Ÿä¸Šæ‰‹ï¼‰

**éœ€æ±‚:** å¿«é€Ÿä½“éªŒ HiMarket åŠŸèƒ½

```bash
# ä½¿ç”¨ Makefile
make install-minimal

# æˆ–ä½¿ç”¨ Helm
helm install himarket . -f values-minimal.yaml
```

**åŒ…å«:**
- HiMarket Server
- å†…ç½® MySQL (5Gi)
- NodePort Service (30080)
- ç®¡ç†å‘˜ + å¼€å‘è€…è´¦å·

**è®¿é—®:**
```bash
kubectl port-forward svc/himarket-himarket-auto-init 8080:8080
# è®¿é—® http://localhost:8080
```

---

### åœºæ™¯ 2: æµ‹è¯•ç¯å¢ƒï¼ˆé›†æˆ Nacos å’Œ MCPï¼‰

**éœ€æ±‚:** æµ‹è¯•å®Œæ•´çš„ API ç®¡ç†åŠŸèƒ½

```bash
helm install himarket . -f values-full.yaml
```

**åŒ…å«:**
- HiMarket Server
- å†…ç½® MySQL (20Gi)
- Nacos é›†æˆ
- Higress ç½‘å…³é›†æˆ
- 5 ä¸ªå†…ç½® MCP Server è‡ªåŠ¨å¯¼å…¥å’Œä¸Šæ¶

**MCP Server åˆ—è¡¨:**
1. `context7` - æ–‡æ¡£ä¸Šä¸‹æ–‡æŸ¥è¯¢
2. `git` - Git ä»“åº“æ“ä½œ
3. `Time` - æ—¶åŒºæ—¶é—´è½¬æ¢
4. `memory` - çŸ¥è¯†å›¾è°±ç®¡ç†
5. `fetch` - ç½‘é¡µå†…å®¹æŠ“å–

---

### åœºæ™¯ 3: ç”Ÿäº§ç¯å¢ƒï¼ˆä½¿ç”¨é˜¿é‡Œäº‘æœåŠ¡ï¼‰

**éœ€æ±‚:** éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ACKï¼Œä½¿ç”¨ RDSã€MSE Nacosã€AI ç½‘å…³

**æ­¥éª¤:**

1. **ç¼–è¾‘ values-commercial.yaml**

```yaml
# ä¿®æ”¹ä»¥ä¸‹é…ç½®ä¸ºçœŸå®å€¼
mysql:
  external:
    host: rm-xxx.mysql.rds.aliyuncs.com
    password: your-rds-password

nacos:
  serverUrl: mse-xxx.nacos-ans.mse.aliyuncs.com:8848
  accessKey: LTAI5t...
  secretKey: xxx...
  username: nacos
  password: your-nacos-password

gateway:
  apig:
    accessKey: LTAI5t...
    secretKey: xxx...
```

2. **éƒ¨ç½²**

```bash
helm install himarket . -f values-commercial.yaml
```

3. **éªŒè¯**

```bash
# æŸ¥çœ‹æœåŠ¡
kubectl get svc himarket-himarket-auto-init

# è·å– LoadBalancer IP
export SERVICE_IP=$(kubectl get svc himarket-himarket-auto-init -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
echo "è®¿é—®: http://$SERVICE_IP:8080"
```

---

## ğŸ“‹ é…ç½®è¯´æ˜

### æ ¸å¿ƒé…ç½®é¡¹

#### 1. MySQL é…ç½®

```yaml
# ä½¿ç”¨å†…ç½® MySQLï¼ˆé€‚åˆå¼€å‘/æµ‹è¯•ï¼‰
mysql:
  enabled: true
  builtin:
    storage: 10Gi
    rootPassword: himarket123

# ä½¿ç”¨å¤–éƒ¨ MySQLï¼ˆé€‚åˆç”Ÿäº§ï¼‰
mysql:
  enabled: false
  external:
    host: mysql.default.svc.cluster.local
    password: yourpassword
```

#### 2. Nacos é…ç½®

```yaml
# å¼€æº Nacos
nacos:
  enabled: true
  serverUrl: http://nacos:8848
  username: nacos
  password: nacos

# å•†ä¸šåŒ– Nacosï¼ˆé˜¿é‡Œäº‘ MSEï¼‰
nacos:
  enabled: true
  serverUrl: mse-xxx.nacos-ans.mse.aliyuncs.com:8848
  accessKey: LTAI5t...
  secretKey: xxx...
  username: nacos
  password: nacos
```

#### 3. ç½‘å…³é…ç½®

```yaml
# Higress ç½‘å…³
gateway:
  enabled: true
  type: HIGRESS
  higress:
    url: http://higress-console:8080
    username: admin
    password: admin

# é˜¿é‡Œäº‘ AI ç½‘å…³
gateway:
  enabled: true
  type: APIG_AI
  apig:
    region: cn-hangzhou
    accessKey: LTAI5t...
    secretKey: xxx...
```

#### 4. MCP é…ç½®

```yaml
mcp:
  importToNacos: true       # å¯¼å…¥ MCP åˆ° Nacos
  publishToHimarket: true   # ä¸Šæ¶ MCP åˆ° HiMarketï¼ˆé»˜è®¤å¯ç”¨ï¼‰
  # ä½¿ç”¨é•œåƒå†…ç½®çš„ nacos-mcp.json
```

---

## ğŸ”§ å¸¸ç”¨æ“ä½œ

### æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€

```bash
# ä½¿ç”¨ Makefile
make status

# æˆ–ä½¿ç”¨ kubectl
kubectl get pods -l app.kubernetes.io/name=himarket-auto-init
kubectl get svc -l app.kubernetes.io/name=himarket-auto-init
```

### æŸ¥çœ‹åˆå§‹åŒ–æ—¥å¿—

```bash
# ä½¿ç”¨ Makefile
make logs

# æˆ–ä½¿ç”¨ kubectl
kubectl logs -f -l app.kubernetes.io/name=himarket-auto-init
```

### æ›´æ–°é…ç½®

```bash
# ä¿®æ”¹æŸä¸ªå‚æ•°
helm upgrade himarket . --set nacos.enabled=true --reuse-values

# ä½¿ç”¨æ–°çš„ values æ–‡ä»¶
helm upgrade himarket . -f values-full.yaml
```

### å¸è½½

```bash
# ä½¿ç”¨è„šæœ¬
./uninstall.sh

# æˆ–ä½¿ç”¨ Makefile
make uninstall

# æˆ–ä½¿ç”¨ Helm
helm uninstall himarket
```

### å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬æ•°æ®ï¼‰

```bash
# ä½¿ç”¨ Makefile
make clean

# æˆ–æ‰‹åŠ¨æ‰§è¡Œ
helm uninstall himarket
kubectl delete pvc -l app.kubernetes.io/instance=himarket
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‰¯æœ¬æ•°é™åˆ¶

**å»ºè®®ä¿æŒ `replicaCount: 1`**

åŸå› ï¼šå¤šä¸ª Pod åŒæ—¶æ‰§è¡Œåˆå§‹åŒ–å¯èƒ½å¯¼è‡´ï¼š
- æ•°æ®åº“å†²çªï¼ˆé‡å¤åˆ›å»ºè´¦å·ï¼‰
- Token ç«äº‰
- Portal é‡å¤åˆ›å»º

å¦‚éœ€é«˜å¯ç”¨ï¼Œå»ºè®®ï¼š
- ä½¿ç”¨å¤–éƒ¨ MySQLï¼ˆæ”¯æŒå¹¶å‘ï¼‰
- åˆå§‹åŒ–å®Œæˆåå†æ‰©å®¹
- æˆ–ç¦ç”¨è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆ`autoInit: false`ï¼‰

### 2. èµ„æºè¦æ±‚

| ç¯å¢ƒ | CPU | å†…å­˜ | MySQL å­˜å‚¨ |
|------|-----|------|-----------|
| å¼€å‘ | 250m-1000m | 512Mi-1Gi | 5Gi |
| æµ‹è¯• | 500m-2000m | 1Gi-2Gi | 10Gi |
| ç”Ÿäº§ | 2000m-8000m | 4Gi-8Gi | 20Gi+ |

### 3. å•†ä¸šåŒ– Nacos ç™½åå•

ä½¿ç”¨é˜¿é‡Œäº‘ MSE Nacos æ—¶ï¼Œéœ€è¦ï¼š
1. è·å– Pod çš„å‡ºå£ IP
2. åœ¨ MSE æ§åˆ¶å°æ·»åŠ ç™½åå•
3. æˆ–ä½¿ç”¨ VPC å†…ç½‘åœ°å€ï¼ˆæ¨èï¼‰

```bash
# æŸ¥çœ‹ Pod IP
kubectl get pod -o wide
```

### 4. å®‰å…¨å»ºè®®

**ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹é»˜è®¤å¯†ç ï¼**

```yaml
himarket:
  admin:
    password: use-strong-password-here  # âš ï¸ å¿…é¡»ä¿®æ”¹
  developer:
    password: use-strong-password-here  # âš ï¸ å¿…é¡»ä¿®æ”¹

mysql:
  builtin:
    rootPassword: use-strong-password-here  # âš ï¸ å¿…é¡»ä¿®æ”¹
```

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### 1. Pod æ— æ³•å¯åŠ¨

**ç—‡çŠ¶:** Pod çŠ¶æ€ä¸º `Pending` æˆ– `ImagePullBackOff`

**æ’æŸ¥:**
```bash
kubectl describe pod -l app.kubernetes.io/name=himarket-auto-init
```

**å¸¸è§åŸå› :**
- é•œåƒåœ°å€é”™è¯¯
- èµ„æºä¸è¶³
- PVC æ— æ³•ç»‘å®š
- é•œåƒæ‹‰å–æƒé™

**è§£å†³:**
```bash
# æ£€æŸ¥é•œåƒ
kubectl get pod -o jsonpath='{.spec.containers[0].image}'

# æ£€æŸ¥èµ„æº
kubectl top nodes

# æ£€æŸ¥ PVC
kubectl get pvc
```

---

### 2. åˆå§‹åŒ–å¤±è´¥

**ç—‡çŠ¶:** Pod è¿è¡Œä½†åˆå§‹åŒ–æ­¥éª¤å¤±è´¥

**æ’æŸ¥:**
```bash
kubectl logs -l app.kubernetes.io/name=himarket-auto-init --tail=500
```

**å¸¸è§é”™è¯¯:**

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ³• |
|---------|------|---------|
| `Connection refused` | MySQL æœªå°±ç»ª | å¢åŠ  `initDelay` |
| `Nacos è¿æ¥å¤±è´¥` | Nacos åœ°å€é”™è¯¯æˆ–ç™½åå• | æ£€æŸ¥åœ°å€å’Œç™½åå• |
| `Token æå–å¤±è´¥` | è´¦å·å¯†ç é”™è¯¯ | æ£€æŸ¥ `ADMIN_PASSWORD` |
| `MCP å¯¼å…¥å¤±è´¥` | Nacos è®¤è¯å¤±è´¥ | æ£€æŸ¥ `NACOS_USERNAME` å’Œ `NACOS_PASSWORD` |

**è§£å†³:**
```bash
# é‡æ–°åˆå§‹åŒ–ï¼ˆåˆ é™¤ Podï¼‰
kubectl delete pod -l app.kubernetes.io/name=himarket-auto-init

# å¢åŠ åˆå§‹åŒ–å»¶è¿Ÿ
helm upgrade himarket . --set initDelay=30 --reuse-values
```

---

### 3. MySQL è¿æ¥é—®é¢˜

**ç—‡çŠ¶:** `Error connecting to MySQL`

**æ’æŸ¥:**
```bash
# æ£€æŸ¥ MySQL Pod
kubectl get pods -l app.kubernetes.io/component=mysql

# æµ‹è¯•è¿æ¥
kubectl exec -it <himarket-pod> -- \
  mysql -h <mysql-host> -u root -p
```

**è§£å†³:**
```bash
# æŸ¥çœ‹ MySQL æ—¥å¿—
kubectl logs -l app.kubernetes.io/component=mysql

# é‡å¯ MySQL Pod
kubectl delete pod -l app.kubernetes.io/component=mysql
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **[README.md](./README.md)** - å®Œæ•´è¯´æ˜æ–‡æ¡£
- **[QUICKSTART.md](./QUICKSTART.md)** - 5 åˆ†é’Ÿå¿«é€Ÿå¼€å§‹
- **[USAGE.md](./USAGE.md)** - è¯¦ç»†ä½¿ç”¨æŒ‡å—
- **[CHANGELOG.md](./CHANGELOG.md)** - ç‰ˆæœ¬å˜æ›´å†å²

---

## ğŸ”— å‚è€ƒé“¾æ¥

- **HiMarket é¡¹ç›®**: https://github.com/alibaba/higress
- **Helm æ–‡æ¡£**: https://helm.sh/docs/
- **Kubernetes æ–‡æ¡£**: https://kubernetes.io/docs/

---

## ğŸ’¬ è·å–å¸®åŠ©

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥é˜…æœ¬æ–‡æ¡£å’Œ README.md
2. æ£€æŸ¥æ—¥å¿—æ’æŸ¥é—®é¢˜
3. æäº¤ GitHub Issue

---

**ç¥ä½ éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰

